#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   ./bin/nixcat > /tmp/nix-snapshot.txt
#   ./bin/nixcat modules/home/keyring.nix modules/nixos/networking.nix > /tmp/nix-snapshot.txt
#
# Purpose:
#   Concatenate relevant NixOS config files for sharing/debugging (e.g. with ChatGPT).
#   Uses git ls-files to avoid secrets and untracked files.
#
# Notes:
# - Only includes tracked files (git ls-files), which helps avoid secrets/untracked junk.
# - Adds clear file boundary markers for readability.

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$ROOT"

# Core files/paths to always include.
core=(
  flake.nix
  flake.lock
  hosts/dell/default.nix
  hosts/dell/hardware-configuration.nix
  home/jeffu/default.nix
  modules/home/default.nix
)

# Extra paths passed on the command line (files or directories).
extra=( "$@" )

emit() {
  local f="$1"
  [ -f "$f" ] || return 0
  printf "\n===== %s =====\n" "$f"
  sed -e 's/\t/  /g' "$f"
}

# Core first
git ls-files -z -- "${core[@]}" \
| tr '\0' '\n' \
| while IFS= read -r f; do emit "$f"; done

# Then extras (if any)
if [ "${#extra[@]}" -gt 0 ]; then
  printf "\n##### EXTRAS #####\n"
  git ls-files -z -- "${extra[@]}" \
  | tr '\0' '\n' \
  | while IFS= read -r f; do emit "$f"; done
fi

